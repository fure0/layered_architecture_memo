# レイヤードアーキテクチャ構成ドキュメント

## 概要

このプロジェクトは、NestJSを使用したクリーンアーキテクチャ（レイヤードアーキテクチャ）で構築されています。サービス一覧APIを中心とした実装を通じて、各層の責務と依存関係を明確に分離しています。

## アーキテクチャ全体図

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Controllers   │  │      DTOs       │  │ Middleware   │ │
│  │                 │  │                 │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Services      │  │   Query/Command │  │     DTOs     │ │
│  │                 │  │    Handlers     │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │    Entities     │  │ Value Objects   │  │  Policies    │ │
│  │                 │  │                 │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │  Repositories   │  │ Specifications  │                   │
│  │  (Interfaces)   │  │                 │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                Infrastructure Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  Repositories   │  │   Query Builder │  │   Mappers    │ │
│  │(Implementations)│  │                 │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## フォルダ構成と役割

### ルートディレクトリ構成

```
src/
├── core/                    # コア機能（横断的関心事）
├── modules/                 # ビジネスモジュール
└── shared/                  # 共有コンポーネント
```

#### core/ - コア機能
- **infrastructure/**: データベース接続、ログ機能など技術的な基盤
- **presentation/**: 認証、ミドルウェア、デコレータなどHTTP層の共通機能

#### modules/ - ビジネスモジュール
- **app.module.ts**: アプリケーションのルートモジュール
- **service/**: サービス関連の機能を4層構造で実装

#### shared/ - 共有コンポーネント
- **constants/**: アプリケーション全体で使用する定数
- **enums/**: 列挙型定義
- **exceptions/**: カスタム例外クラス
- **types/**: TypeScript型定義
- **utils/**: 汎用ユーティリティ関数

### サービスモジュール詳細構成

```
src/modules/service/
├── service.module.ts        # モジュール定義・依存性注入設定
├── presentation/            # プレゼンテーション層
├── application/             # アプリケーション層
├── domain/                  # ドメイン層
└── infrastructure/          # インフラストラクチャ層
```

## 各層の役割

### 1. プレゼンテーション層 (presentation/)
**役割**: HTTPリクエスト/レスポンスの処理

- **controllers/**: RESTエンドポイントの定義、リクエスト受信
- **dto/request/**: リクエストパラメータの型定義・バリデーション
- **dto/response/**: APIレスポンスの型定義・フォーマット

### 2. アプリケーション層 (application/)
**役割**: ビジネスロジックの調整、ユースケースの実装

- **services/**: ビジネスロジックの調整、サイト別処理の振り分け
- **queries/**: CQRS実装（クエリオブジェクト・ハンドラー）
- **dto/**: アプリケーション内部で使用するデータ転送オブジェクト

### 3. ドメイン層 (domain/)
**役割**: ビジネスルールの実装、ドメインモデルの定義

- **entities/**: ビジネスエンティティ、ドメインロジック
- **value-objects/**: 値オブジェクト（ID、名前など）
- **repositories/**: データアクセスのインターフェース定義
- **policies/**: ビジネスポリシー・ルール
- **specifications/**: 検索・フィルタリング仕様

### 4. インフラストラクチャ層 (infrastructure/)
**役割**: 外部システムとの連携、データ永続化

- **repositories/**: データベースアクセスの具体実装（Prisma）
- **mappers/**: データベースモデルとドメインエンティティの変換
- **query-builders/**: 動的クエリ構築

## 依存関係の原則

各層は以下の原則に従って設計されています：

1. **上位層から下位層への依存**: Presentation → Application → Domain
2. **依存性逆転の原則**: Infrastructure層はDomain層のインターフェースを実装
3. **共通コンポーネントの活用**: Shared層とCore層は全層から参照可能

## API仕様

### サービス一覧取得API
- **エンドポイント**: `GET /api/v1/contents/services`
- **機能**: サイト別サービス一覧取得、検索・フィルタリング・ソート、ページネーション
- **サイト別動作**:
  - **管理サイト**: 全サービスアクセス可能
  - **企業サイト**: 自社サービスのみアクセス可能
  - **ポータルサイト**: 公開サービスのみアクセス可能

## 設計パターン

1. **レイヤードアーキテクチャ**: 責務の分離
2. **CQRS**: 読み取りと書き込みの分離
3. **Repository パターン**: データアクセスの抽象化
4. **Dependency Injection**: 依存性の注入
5. **Strategy パターン**: サイト別処理の振り分け
6. **Builder パターン**: クエリ構築
7. **Mapper パターン**: データ変換

## まとめ

このレイヤードアーキテクチャにより以下を実現：

- **保守性**: 各層の責務が明確、変更影響範囲の限定
- **テスタビリティ**: 各層の独立テスト
- **拡張性**: 新機能追加の容易さ
- **再利用性**: 共通コンポーネントの活用
- **可読性**: 明確な構造

サービス一覧APIを通じて、クリーンアーキテクチャの原則に従った堅牢で保守性の高いシステムを構築しています。
