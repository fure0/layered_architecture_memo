# ä¾‹å¤–å‡¦ç†ã®å‹•ä½œåŸç†

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€NestJSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¾‹å¤–å‡¦ç†ã®å‹•ä½œåŸç†ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹ã€‚`throw new`ã§ç™ºç”Ÿã•ã›ãŸä¾‹å¤–ãŒã©ã®ã‚ˆã†ã«HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¤‰æ›ã•ã‚Œã‚‹ã‹ã€ãã®è©³ç´°ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’è§£èª¬ã™ã‚‹

## ä¾‹å¤–å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
1. Serviceã§ä¾‹å¤–ãŒç™ºç”Ÿ
   â†“
   throw new BadRequestException('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸')
   
2. NestJSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
   â†“
   (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼/ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§throwã•ã‚ŒãŸä¾‹å¤–ã‚’è‡ªå‹•æ¤œçŸ¥)
   
3. HttpExceptionFilterãŒä¾‹å¤–ã‚’å‡¦ç†
   â†“
   (main.tsã§ç™»éŒ²ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)
   
4. ä¾‹å¤–ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
   â†“
   
5. JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
```

## ä¸»è¦ãªæ§‹æˆè¦ç´ 

### 1. ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®æ§‹é€ 

ã™ã¹ã¦ã®ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã¯`BaseException`ã‚’ç¶™æ‰¿ã—ã€`statusCode`ã¨`code`ã‚’æŒã¤

#### BaseExceptionï¼ˆåŸºåº•ã‚¯ãƒ©ã‚¹ï¼‰

```typescript
src/core/exceptions/base.exception.ts 1:12

export abstract class BaseException extends Error {
  abstract readonly code: string;
  abstract readonly statusCode: number;

  constructor(
    message: string,
    public readonly details?: Record<string, unknown>,
  ) {
    super(message);
    this.name = this.constructor.name;
  }
}
```

#### å…·ä½“ä¾‹ï¼šBadRequestException

```typescript
src/core/exceptions/common.exceptions.ts 69:79

// 400 Bad Request
export class BadRequestException extends BaseException {
  readonly code = 'BAD_REQUEST';
  readonly statusCode = 400;

  constructor(
    message: string = 'ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™',
    details?: Record<string, unknown>,
  ) {
    super(message, details);
  }
}
```

#### åˆ©ç”¨å¯èƒ½ãªä¾‹å¤–ã‚¯ãƒ©ã‚¹

- `NotFoundException` (404) - ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
- `UnauthorizedException` (401) - èªè¨¼ãŒå¿…è¦ãªå ´åˆ
- `AccessDeniedException` (403) - ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸå ´åˆ
- `BadRequestException` (400) - ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `CustomBadRequestException` (400) - ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰ä»˜ãã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
- `ValidationException` (422) - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
- `ConflictException` (409) - ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆ
- `TooManyRequestsException` (429) - ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
- `InternalServerErrorException` (500) - ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

### 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ç™»éŒ²

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«`main.ts`ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹ï¼š

```typescript
src/main.ts 37:39

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¨­å®š
logger.log('ğŸ”§ ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šä¸­...');
app.useGlobalFilters(new HttpExceptionFilter());
```

ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ç™ºç”Ÿã™ã‚‹ã™ã¹ã¦ã®ä¾‹å¤–ãŒè‡ªå‹•çš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§å‡¦ç†ã•ã‚Œã‚‹

### 3. ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å‹•ä½œåŸç†

#### HttpExceptionFilterã®å®Ÿè£…

```typescript
src/core/presentation/filters/http-exception.filter.ts 20:71

@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = 500;
    let errorResponse: ErrorResponse = {
      success: false,
      error: {
        code: 'INTERNAL_SERVER_ERROR',
        message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
        status: 500,
      },
    };

    if (exception instanceof BaseException) {
      status = exception.statusCode;
      errorResponse = {
        success: false,
        error: {
          code: exception.code,
          message: exception.message,
          details: exception.details,
          status: exception.statusCode,
        },
      };
    } else if (exception instanceof HttpException) {
      status = exception.getStatus();
      const exceptionResponse = exception.getResponse();
      errorResponse = {
        success: false,
        error: {
          code: 'HTTP_EXCEPTION',
          message: exception.message,
          details: exceptionResponse,
          status,
        },
      };
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²
    console.error('Exception caught:', {
      url: request.url,
      method: request.method,
      error: exception instanceof Error ? exception.message : exception,
      stack: exception instanceof Error ? exception.stack : undefined,
    });

    response.status(status).json(errorResponse);
  }
}
```

#### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. **ä¾‹å¤–ã®ã‚­ãƒ£ãƒƒãƒ**: `@Catch()`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®ä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
2. **HTTPã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—**: `ArgumentsHost`ã‹ã‚‰Expressã®`Request`ã¨`Response`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
3. **ä¾‹å¤–ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š**:
   - `instanceof BaseException`: ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã®å ´åˆã€ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`statusCode`ã€`code`ã€`message`ã€`details`ã‚’ä½¿ç”¨
   - `instanceof HttpException`: NestJSã®æ¨™æº–ä¾‹å¤–ã®å ´åˆã€`getStatus()`ã¨`getResponse()`ã‚’ä½¿ç”¨
   - ãã®ä»–: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§500ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
4. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¨˜éŒ²**: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
5. **HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ**: `response.status(status).json(errorResponse)`ã§JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´

## å‹•ä½œã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°èª¬æ˜

### ã‚¹ãƒ†ãƒƒãƒ—1: Serviceã§ä¾‹å¤–ãŒç™ºç”Ÿ

ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®çµæœã¨ã—ã¦ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ï¼š

```typescript
src/modules/favorites/application/services/favoriteInfo.service.ts 609:615

if (action === 'CREATE') {
  // ãŠæ°—ã«å…¥ã‚Šç™»éŒ² é‡è¤‡ã®å ´åˆ
  if (length > 0) {
    throw new BadRequestException(
      `ã“ã®${favoriteDivName}ã¯æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,
    );
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—2: NestJSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ

- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã©ã€ä»»æ„ã®å±¤ã§`throw`ã•ã‚ŒãŸä¾‹å¤–ãŒNestJSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«æ¤œçŸ¥ã•ã‚Œã‚‹
- å‡¦ç†ã•ã‚Œã¦ã„ãªã„ä¾‹å¤–ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è‡ªå‹•çš„ã«è»¢é€ã•ã‚Œã‚‹

### ã‚¹ãƒ†ãƒƒãƒ—3: HttpExceptionFilterãŒä¾‹å¤–ã‚’å‡¦ç†

ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ä¾‹å¤–ã‚’å‡¦ç†ã™ã‚‹ï¼š

```typescript
if (exception instanceof BaseException) {
  // ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã®å ´åˆ
  status = exception.statusCode;  // ä¾‹: 400
  errorResponse = {
    success: false,
    error: {
      code: exception.code,           // ä¾‹: "BAD_REQUEST"
      message: exception.message,      // ä¾‹: "ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"
      details: exception.details,     // è¿½åŠ ã®è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      status: exception.statusCode,   // ä¾‹: 400
    },
  };
}
```

### ã‚¹ãƒ†ãƒƒãƒ—4: HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ

å¤‰æ›ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã•ã‚Œã‚‹ï¼š

```json
HTTP 400 Bad Request
{
  "success": false,
  "error": {
    "code": "BAD_REQUEST",
    "message": "ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™",
    "status": 400
  }
}
```

## å®Ÿéš›ã®ä½¿ç”¨ä¾‹

### ä¾‹1: ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯

```typescript
// favoriteInfo.service.ts
checkFavoriteInfoExists(action: string, division: number, length: number): void {
  const favoriteDivName = this.getFavoriteDivName(division);

  if (action === 'CREATE') {
    if (length > 0) {
      throw new BadRequestException(
        `ã“ã®${favoriteDivName}ã¯æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`,
      );
    }
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": false,
  "error": {
    "code": "BAD_REQUEST",
    "message": "ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™",
    "status": 400
  }
}
```

### ä¾‹2: ãŠæ°—ã«å…¥ã‚Šæ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯

```typescript
// favoriteInfo.service.ts
async checkFavoriteCountLimit(memberId: string, favoriteDiv: number): Promise<void> {
  const favoriteCount = await this.getFavoriteCount(memberId, favoriteDiv);
  const favoriteDivName = this.getFavoriteDivName(favoriteDiv);

  if (favoriteCount > 50) {
    throw new CustomBadRequestException(
      'FAVORITE_COUNT_LIMIT_EXCEEDED',
      `${favoriteDivName}ãŠæ°—ã«å…¥ã‚Šæ•°ãŒ50ã‚’è¶…ãˆã¦ã„ã¾ã™`,
    );
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": false,
  "error": {
    "code": "FAVORITE_COUNT_LIMIT_EXCEEDED",
    "message": "ã‚µãƒ¼ãƒ“ã‚¹ãŠæ°—ã«å…¥ã‚Šæ•°ãŒ50ã‚’è¶…ãˆã¦ã„ã¾ã™",
    "status": 400
  }
}
```

### ä¾‹3: å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

```typescript
// favoriteInfo.service.ts
catch (error) {
  this.logger.error('ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ç™»éŒ²ã‚¨ãƒ©ãƒ¼', {
    error: error instanceof Error ? error.message : String(error),
    // ...
  });

  throw new InternalServerErrorException(
    'ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ã®ç™»éŒ²ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
  );
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ã®ç™»éŒ²ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
    "status": 500
  }
}
```

## ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼

### æ¨™æº–çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ 

ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä»¥ä¸‹ã®å½¢å¼ã«å¾“ã†ï¼š

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;        // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "BAD_REQUEST"ï¼‰
    message: string;      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆäººé–“ãŒèª­ã‚ã‚‹å½¢å¼ï¼‰
    status: number;      // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 400ï¼‰
    details?: unknown;   // è¿½åŠ ã®è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  };
}
```

### ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO

Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”¨ã®DTOå®šç¾©ï¼š

```typescript
src/shared/dto/error-response.dto.ts 1:86
import { ApiProperty } from '@nestjs/swagger';

export class ErrorResponse {
  @ApiProperty({
    description: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æˆåŠŸ/å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    example: false,
  })
  success: boolean;

  @ApiProperty({
    description: 'ã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±',
    type: 'object',
    properties: {
      code: {
        type: 'string',
        description: 'ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰',
      },
      message: {
        type: 'string',
        description: 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
      },
      status: {
        type: 'number',
        description: 'HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰',
      },
      details: {
        type: 'object',
        description: 'è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ç­‰ï¼‰',
        additionalProperties: true,
      },
    },
    examples: {
      badRequest: {
        summary: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼',
        value: {
          code: 'missing_site_identifier',
          message: 'X-Site-Identifierãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦ã§ã™',
          status: 400,
        },
      },
      accessDenied: {
        summary: 'ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦',
        value: {
          code: 'ACCESS_DENIED',
          message: 'ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',
          status: 403,
          details: {
            resource: 'ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§',
            reason:
              'ã‚µã‚¤ãƒˆã®æ¨©é™è¨­å®šã«ã‚ˆã‚Šã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“',
          },
        },
      },
      validationError: {
        summary: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼',
        value: {
          code: 'INVALID_PARAMETERS',
          message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™',
          status: 422,
          details: {
            page: 'ãƒšãƒ¼ã‚¸ç•ªå·ã¯1ä»¥ä¸Šã®æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™',
            per_page: '1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°ã¯1-100ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„',
            q: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
          },
        },
      },
      serverError: {
        summary: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼',
        value: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          status: 500,
          details: {
            context: 'GetServicesHandler.execute',
          },
        },
      },
    },
  })
  error: {
    code: string;
    message: string;
    status: number;
    details?: Record<string, unknown>;
  };
}
```

## é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### 1. `@Catch()`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§ä½¿ç”¨ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¾ã™
- ç‰¹å®šã®ä¾‹å¤–ã®ã¿ã‚’ã‚­ãƒ£ãƒƒãƒã—ãŸã„å ´åˆã¯ã€`@Catch(BadRequestException)`ã®ã‚ˆã†ã«æŒ‡å®šå¯èƒ½

### 2. `instanceof`ãƒã‚§ãƒƒã‚¯

- ä¾‹å¤–ã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç•°ãªã‚‹å‡¦ç†ã‚’å®Ÿè¡Œ
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ï¼ˆ`BaseException`ï¼‰ã¨NestJSæ¨™æº–ä¾‹å¤–ï¼ˆ`HttpException`ï¼‰ã‚’åŒºåˆ¥ã—ã¦å‡¦ç†

### 3. è‡ªå‹•ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›

- ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆ`statusCode`ã€`code`ã€`message`ã€`details`ï¼‰ã‚’è‡ªå‹•çš„ã«JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¤‰æ›
- é–‹ç™ºè€…ã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã ã‘ã§ã€HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹ç¯‰ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã¯ãªã„

### 4. ä¸€è²«ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

- ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒçµ±ä¸€ã•ã‚ŒãŸæ§‹é€ ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã•ã‚Œã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®¹æ˜“ã«ãªã‚‹

## ä¾‹å¤–å‡¦ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. é©åˆ‡ãªä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®é¸æŠ

```typescript
// âœ… è‰¯ã„ä¾‹ï¼šé©åˆ‡ãªä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
if (!memberId || memberId === '') {
  throw new BadRequestException(FAVORITE_ERROR_MESSAGES.INVALID_MEMBER_ID);
}

if (favoriteCount > 50) {
  throw new CustomBadRequestException(
    'FAVORITE_COUNT_LIMIT_EXCEEDED',
    `${favoriteDivName}ãŠæ°—ã«å…¥ã‚Šæ•°ãŒ50ã‚’è¶…ãˆã¦ã„ã¾ã™`,
  );
}

// âŒ æ‚ªã„ä¾‹ï¼šä¸€èˆ¬çš„ãªErrorã‚’ä½¿ç”¨
throw new Error('Invalid member ID');  // ã“ã‚Œã¯500ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¨˜éŒ²

```typescript
catch (error) {
  // æ§‹é€ åŒ–ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
  this.logger.error('ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ç™»éŒ²ã‚¨ãƒ©ãƒ¼', {
    error: error instanceof Error ? error.message : String(error),
    errorStack: error instanceof Error ? error.stack : undefined,
    favoriteInfo: favoriteInfo,
    module: 'FavoriteInfoService',
    method: 'createFavoriteInfoWithErrorHandling',
    timestamp: new Date().toISOString(),
  });

  throw new InternalServerErrorException(
    'ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ã®ç™»éŒ²ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
  );
}
```

### 3. ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã®å†ã‚¹ãƒ­ãƒ¼

```typescript
catch (error) {
  // ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã¯ãã®ã¾ã¾å†ã‚¹ãƒ­ãƒ¼
  if (
    error instanceof ValidationException ||
    error instanceof BadRequestException ||
    error instanceof InternalServerErrorException ||
    error instanceof CustomBadRequestException
  ) {
    throw error;  // ãã®ã¾ã¾å†ã‚¹ãƒ­ãƒ¼
  }

  // æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯InternalServerErrorExceptionã«ãƒ©ãƒƒãƒ—
  throw new InternalServerErrorException(
    'ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã®å–å¾—ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
  );
}
```

## ã¾ã¨ã‚

- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚ˆã‚‹è‡ªå‹•å‡¦ç†**: NestJSãŒä¾‹å¤–ã‚’è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒƒãƒã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è»¢é€
- **çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**: ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒåŒã˜æ§‹é€ ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã•ã‚Œã‚‹
- **é–‹ç™ºè€…ä½“é¨“ã®å‘ä¸Š**: ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«é›†ä¸­ã—ã€ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã ã‘ã§HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: ä¾‹å¤–å‡¦ç†ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸€ç®‡æ‰€ï¼ˆ`HttpExceptionFilter`ï¼‰ã«é›†ç´„ã•ã‚Œã€å¤‰æ›´ãŒå®¹æ˜“

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿç¾ã•ã‚Œã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–“ã§æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼å¥‘ç´„ãŒç¢ºç«‹ã•ã‚Œã‚‹

